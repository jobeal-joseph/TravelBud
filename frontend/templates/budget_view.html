<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Budget Tracker | TravelBud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass-card { background: white; border-radius: 20px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .total-badge { background: #000; color: #fff; padding: 15px; border-radius: 12px; display: inline-block; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <h2 class="fw-bold m-0" id="trip-title">Budget Manager</h2>
            <a href="/search" class="btn btn-dark rounded-pill px-4">New Search</a>
        </div>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card glass-card p-4">
                    <h5 class="fw-bold mb-4">Add Expense</h5>
                    <label class="small fw-bold text-muted">CATEGORY</label>
                    <select id="cat" class="form-select mb-3 border-0 bg-light">
                        <option>Food</option>
                        <option>Stay</option>
                        <option>Transport</option>
                        <option>Fun</option>
                    </select>
                    <label class="small fw-bold text-muted">DESCRIPTION</label>
                    <input type="text" id="desc" class="form-control mb-3 border-0 bg-light" placeholder="e.g. Lunch">
                    <label class="small fw-bold text-muted">AMOUNT ($)</label>
                    <input type="number" id="amt" class="form-control mb-4 border-0 bg-light" placeholder="0.00">
                    <button class="btn btn-primary w-100 py-3 fw-bold rounded-3" onclick="addExp()">Save Expense</button>
                </div>
            </div>
            <div class="col-md-8 text-center">
                <div class="card glass-card p-4 h-100">
                    <div class="total-badge mb-4"><h4>Total: $<span id="total-val">0</span></h4></div>
                    <div style="max-height: 350px;" class="d-flex justify-content-center">
                        <canvas id="chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart;
        
        // 1. Get data from localStorage
        const tripId = localStorage.getItem('trip_id');
        const cityName = localStorage.getItem('city_name');

        // 2. Redirect if user hasn't searched a city first (Safety Check)
        if (!tripId || tripId === "null") {
            alert("Please select a city first!");
            window.location.href = '/search';
        }

        // 3. Set the title to the city name
        document.getElementById('trip-title').innerText = `Budget for ${cityName}`;

        async function addExp() {
            const amtInput = document.getElementById('amt');
            const descInput = document.getElementById('desc');
            const catInput = document.getElementById('cat');

            if(!amtInput.value) return alert("Please enter an amount");

            // 4. Post data with current tripId
            const response = await fetch('/api/budget/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    trip_id: tripId,
                    category: catInput.value,
                    description: descInput.value,
                    amount: amtInput.value
                })
            });

            if(response.ok) {
                amtInput.value = '';
                descInput.value = '';
                updateUI(); 
            } else {
                alert("Error saving expense. Try resetting the database.");
            }
        }

        async function updateUI() {
            // 5. Fetch summary specifically for this trip
            const res = await fetch(`/api/budget/summary?trip_id=${tripId}`);
            const data = await res.json();
            
            document.getElementById('total-val').innerText = data.total || 0;

            const ctx = document.getElementById('chart').getContext('2d');
            if(chart) chart.destroy();
            
            // Only draw chart if there is data
            if (Object.keys(data.breakdown).length > 0) {
                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data.breakdown),
                        datasets: [{
                            data: Object.values(data.breakdown),
                            backgroundColor: ['#0d6efd', '#ffc107', '#198754', '#dc3545']
                        }]
                    },
                    options: { plugins: { legend: { position: 'bottom' } } }
                });
            }
        }

        window.onload = updateUI;
    </script>
</body>
</html>